name: Docker Publish

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    types: [opened, synchronize, reopened]

env:
  REGISTRY: ghcr.io
  # Repository name for image naming
  IMAGE_BASE: ghcr.io/${{ github.repository_owner }}

jobs:
  build-and-push:
    name: Build & Push (${{ matrix.target }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - target: control-plane
            dockerfile: docker/Dockerfile.unified
            image_name: everruns-control-plane
          - target: worker
            dockerfile: docker/Dockerfile.unified
            image_name: everruns-worker
          - target: admin
            dockerfile: docker/Dockerfile.unified
            image_name: everruns-admin
          - target: ui
            dockerfile: apps/ui/Dockerfile
            image_name: everruns-ui
            context: apps/ui

    steps:
      - uses: actions/checkout@v4

      # QEMU needed for ARM builds (main branch, tags, and test branch)
      # TODO: Remove temporary branch override after testing
      - name: Set up QEMU
        if: github.event_name == 'push' || github.head_ref == 'claude/add-arm-image-building-LijHE'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine SHA
        id: sha
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
            echo "sha_short=$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          else
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      # Build ARM64 only on main push and version tags (cross-compiled)
      # PRs only build amd64 for faster CI
      # TODO: Remove temporary branch override after testing
      - name: Determine platforms
        id: platforms
        run: |
          if [ "${{ github.event_name }}" = "push" ] || [ "${{ github.head_ref }}" = "claude/add-arm-image-building-LijHE" ]; then
            echo "platforms=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
          else
            echo "platforms=linux/amd64" >> $GITHUB_OUTPUT
          fi

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_BASE }}/${{ matrix.image_name }}
          tags: |
            # On main push: tag as 'latest'
            type=raw,value=latest,enable=${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
            # On version tags: use the tag name (e.g., v1.0.0)
            type=ref,event=tag
            # Always tag with short and full SHA
            type=raw,value=${{ steps.sha.outputs.sha_short }}
            type=raw,value=${{ steps.sha.outputs.sha }}

      - name: Build and push ${{ matrix.target }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context || '.' }}
          file: ${{ matrix.dockerfile }}
          target: ${{ matrix.target }}
          platforms: ${{ steps.platforms.outputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=docker-${{ matrix.target }}
          cache-to: type=gha,mode=max,scope=docker-${{ matrix.target }}
